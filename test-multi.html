<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Testing Service for Routing-Multi</title>
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/datepicker3.css" rel="stylesheet">
  <link href="css/styles.css" rel="stylesheet">
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js" type="text/javascript" ></script>
  <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/styles/default.min.css">
  <script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/highlight.min.js"></script>
 <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true&libraries=drawing,places,geometry"></script>
  <script src="routing.js" type="text/javascript" ></script>
  <meta name="description" content="Testing Service for Routing">
  <meta name="author" content="Leonardo Larrea">
</head>
<body>
	<script>hljs.initHighlightingOnLoad();</script>
	
	<script type="text/javascript" >

		//Basic request to only information of the service
	    var map;
	    var index=0;
	    var indexTask=0;
	    var waypoints=[];
	    var wayservice=[];


	    var routePath=[];
	    var interval=[];
        var labelPD=['P','D'];
	    var colorPD=['#209ccc','#fc3c3a'];
	    var indexPD=0;
	    var tasksPD=[];
 		

	    function initialize() {


		  var mapProp = {
		    center:new google.maps.LatLng(-2.2073054,-79.9382544),
		    zoom:14,
		    mapTypeId:google.maps.MapTypeId.ROADMAP
		  };
		  map=new google.maps.Map(document.getElementById("googleMap"),mapProp);
		  map.addListener('click',function(event) {
        	addMarker(event.latLng, 'Click Generated Marker', map);
    	  });

    	    // Try HTML5 geolocation
		  if(navigator.geolocation) {
		    navigator.geolocation.getCurrentPosition(function(position) {
		      var pos = new google.maps.LatLng(position.coords.latitude,
		                                       position.coords.longitude);
		      map.setCenter(pos);
		    }, function() {
		      handleNoGeolocation(true);
		    });
		  } else {
		    // Browser doesn't support Geolocation
		    handleNoGeolocation(false);
		  }

    	  var drawingManager = new google.maps.drawing.DrawingManager({
		   drawingMode: null,
		    draggable: true,
		    drawingControl: true,
		    drawingControlOptions: {
		      position: google.maps.ControlPosition.TOP_CENTER,
		      drawingModes: [
		        google.maps.drawing.OverlayType.POLYGON
		      ]
		    },
		     polygonOptions:{
		       strokeColor:'#FF0000',
		       strokeOpacity: 0.8,
		       strokeWeight: 2,
		       fillColor: '#FF0000',
		       fillOpacity: 0.35,
		       editable: true,
		       geodesic: true
		   },
		    circleOptions: {
		      fillColor: '#ffff00',
		      fillOpacity: 1,
		      strokeWeight: 5,
		      clickable: false,
		      editable: true,
		      zIndex: 1
		    }
		  });
  		  drawingManager.setMap(map);
		}
		google.maps.event.addDomListener(window, 'load', initialize);


		var input = /** @type {HTMLInputElement} */(
		   document.getElementById('pac-input'));
		  map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);

		  var searchBox = new google.maps.places.SearchBox(
		    /** @type {HTMLInputElement} */(input));

		  // [START region_getplaces]
		  // Listen for the event fired when the user selects an item from the
		  // pick list. Retrieve the matching places for that item.
		  google.maps.event.addListener(searchBox, 'places_changed', function() {
		    var places = searchBox.getPlaces();

		    if (places.length == 0) {
		      return;
		    }
		    for (var i = 0, marker; marker = markers[i]; i++) {
		      marker.setMap(null);
		    }

		    // For each place, get the icon, place name, and location.
		    markers = [];
		    var bounds = new google.maps.LatLngBounds();
		    for (var i = 0, place; place = places[i]; i++) {
		      var image = {
		        url: place.icon,
		        size: new google.maps.Size(71, 71),
		        origin: new google.maps.Point(0, 0),
		        anchor: new google.maps.Point(17, 34),
		        scaledSize: new google.maps.Size(25, 25)
		      };

		      // Create a marker for each place.
		      var marker = new google.maps.Marker({
		        map: map,
		        icon: image,
		        title: place.name,
		        position: place.geometry.location
		      });

		      markers.push(marker);

		      bounds.extend(place.geometry.location);
		    }

		    map.fitBounds(bounds);
		   });

		   google.maps.event.addListener(map, "click", function(event){
		                // place a marker
		               
		 });

		

		function addMarker(latlng,title,map) {
			console.log(latlng)
			var image = new google.maps.MarkerImage('./images/marker' + index + '.png',
                      new google.maps.Size(20, 34),
                      new google.maps.Point(0, 0),
                      new google.maps.Point(10, 34));

			//var testDP=Math.floor(Math.random() * 2);



		    var marker = new google.maps.Marker({
		            position: latlng,
		            map: map,
		            label: labelPD[indexPD],
		            icon: {
				        path: google.maps.SymbolPath.CIRCLE,
    					scale: 15,
    					fillColor:colorPD[indexPD],
    					fillOpacity:0.7,
    					strokeColor: '#FFF',
    					strokeWeight:5,
    					strokeOpacity:0.7
				    },
		            title: title,
		            draggable:true
		    });
		    index++;

		    var waypoint={
		    	lat:latlng.lat(),
		    	lng:latlng.lng(),
		    	index:index
		    };
		    waypoints.push(waypoint);

		    marker.index=index;

		    marker.addListener('drag',function(event) {
		      //  document.getElementById('lat').value = event.latLng.lat();
		      //  document.getElementById('lng').value = event.latLng.lng();
		    });

		    marker.addListener('dragend',function(event) {	
		    	console.log(marker.index-1)
		       waypoints[marker.index-1].lat=event.latLng.lat();
		       waypoints[marker.index-1].lng=event.latLng.lng();
		       clearPath();
		       calculate(waypoints);
		    });

		    if(index>1){
		     //  clearPath();
		     //  calculate(waypoints);
		    }

		    //Logic to the task

		    if(indexPD==0){
		    	indexPD=1;
		    	var task=[];
		    	task.push(waypoint);
		    	tasksPD.push(task);
		    }else{
		    	indexPD=0;	
		    	tasksPD[indexTask].push(waypoint);
		    	clearPath();
		    	tasksPD.forEach(function(route){
				    console.log(route)
                    calculate(route);
				});
		        indexTask++;
		    }


		}

		function optimization(){
			new RoutingService().getRouteOptimizationSingle(waypoints,function (error,response) {
				if(error){
					console.log(error)
				}
				console.log(response)
				console.log('ROUTE:'+response.result.routes.length);
				sortRoute(response.result.routes);
			});
		}

		function sortRoute(routes){
			var items=waypoints.map(function(waypoint,index){
                       waypoint.index=index==0?"pickup":""+index;
				return waypoint;
			});

			var sortedroutes=[];
			for(var i=0;i<routes.length;i++){
				var steps=routes[i].steps;
				sortedroutes[i]=[];
				for(var j=0;j<steps.length;j++){
					for(var k=0;k<items.length;k++){
						if(items[k].index==steps[j].task_id){
							console.log('Step :'+steps[j].task_id);
							sortedroutes[i].push(items[k]);
						}
					}	
				}	
			}	
			clearPath();
			sortedroutes.forEach(function(route){
				console.log(route)
                calculate(route);
			});

		}


		function calculate(waypoints_cal){
			
			var items=waypoints_cal.map(function(waypoint){
				delete waypoint.index;
				return waypoint;
			});

			new RoutingService().getRoute(items, true,function (error,response) {
	 			if(error){
	 				var json=JSON.stringify(error, null, 4);
	            	$('#routing').append(json);
	 			}
		    	var json=JSON.stringify(response, null, 4);
		    	$('#routing').empty() 
	            $('#routing').append(json);
	            var colorarrow=getRandomColor();
				var color=getRandomColor();

				var car = "M17.402,0H5.643C2.526,0,0,3.467,0,6.584v34.804c0,3.116,2.526,5.644,5.643,5.644h11.759c3.116,0,5.644-2.527,5.644-5.644 V6.584C23.044,3.467,20.518,0,17.402,0z M22.057,14.188v11.665l-2.729,0.351v-4.806L22.057,14.188z M20.625,10.773 c-1.016,3.9-2.219,8.51-2.219,8.51H4.638l-2.222-8.51C2.417,10.773,11.3,7.755,20.625,10.773z M3.748,21.713v4.492l-2.73-0.349 V14.502L3.748,21.713z M1.018,37.938V27.579l2.73,0.343v8.196L1.018,37.938z M2.575,40.882l2.218-3.336h13.771l2.219,3.336H2.575z M19.328,35.805v-7.872l2.729-0.355v10.048L19.328,35.805z";

				/*var lineSymbol = {
				    path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
				    scale: 4,
				    fillColor:'#F00',
    				fillOpacity:1.0,
				    strokeColor: '#000',
				    offset: '5%'
				};*/

				var lineSymbol = {
					path: car,
				    scale: .4,
				    strokeColor: 'white',
				    strokeWeight: .10,
				    fillOpacity: 1.0,
				    fillColor: '#000',
				    offset: '5%',
				    // rotation: parseInt(heading[i]),
				    anchor: new google.maps.Point(10, 25)
				};

				var lineSymbolDashed = {
				    path: 'M 0,-1 0,1',
				    strokeOpacity: 1,
				    strokeColor: 'black',
				    scale: 4
				  };

				var tmpPath = new google.maps.Polyline({
				    path: response[0].points,
				    geodesic: true,
				    fillColor:'#fff',
    				fillOpacity:0.0,
				    strokeColor: '#fdc824',
				    strokeOpacity: 1.0,
				    strokeWeight: 3,
				    icons: [{
				        icon: lineSymbol,
				        offset: '5%'
				    },{
				     icon: lineSymbolDashed,
      					offset: '0',
      					repeat: '20px'
				    }]
				});



	           /* var tmpPath = new google.maps.Polyline({
				    path: response[0].points,
				    geodesic: true,
				    fillColor:'#fff',
    				fillOpacity:1.0,
				    strokeColor: color,
				    strokeOpacity: 1.0,
				    strokeWeight: 3,
				    icons: [{
				      icon: lineSymbol,
				      offset: '5%'
				    }]
				});*/

				var tmpPath2 = new google.maps.Polyline({
				    path: response[0].points,
				    geodesic: true,
				    fillColor:'#fff',
    				fillOpacity:0.7,
				    strokeColor: '#FFF',
				    strokeOpacity: 0.7,
				    strokeWeight: 7
				});
				tmpPath.setMap(map);
               // tmpPath2.setMap(map);
				
				animateCircle(tmpPath);
				routePath.push(tmpPath2);
				routePath.push(tmpPath);
	    	});
		}

		function getRandomColor() {
		    var letters = '0123456789ABCDEF'.split('');
		    var color = '#';
		    for (var i = 0; i < 6; i++ ) {
		        color += letters[4+Math.floor(Math.random() * 8)];
		    }
		    return color;
		}

		function clearPath(){
			routePath.forEach(function(path){
				path.setMap(null);
			});

			interval.forEach(function(interval_id){
				window.clearInterval(interval_id);
			});
		}

		function animateCircle(line) {
		    var count = 0;
		    interval.push(window.setInterval(function() {
		        count = (count + 1) % 50000;
		        var icons = line.get('icons');
		        icons[0].offset = (count / 4) + '%';
		        line.set('icons', icons);
		    }, 20));
		}

		function handleNoGeolocation(errorFlag) {
		  if (errorFlag) {
		    var content = 'Error: The Geolocation service failed.';
		  } else {
		    var content = 'Error: Your browser doesn\'t support geolocation.';
		  }

		  var options = {
		    map: map,
		    position: new google.maps.LatLng(-2.2073054, -79.9382544),
		    content: content
		  };

		  var infowindow = new google.maps.InfoWindow(options);
		  map.setCenter(options.position);
		}

		new RoutingService().getInfoBase(function (error,response) {
	    	if(error){
 				var json=JSON.stringify(error, null, 4);
            	$('#routing').append(json);
 			}
	    	var json=JSON.stringify(response, null, 4);
            $('#basic').append(json);
           
	    });


	</script>
	
	
	<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
		<div class="container-fluid">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#sidebar-collapse">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="#"><span>OPTIMIZATION</span>ROUTES MULTI</a>
			</div>				
		</div><!-- /.container-fluid -->
	</nav>
		
	<div id="sidebar-collapse" class="col-sm-3 col-lg-2 sidebar">
		<form role="search">
			<div class="form-group">
			      <label for="fleet_size">FLEET SIZE</label>
			      <select id="fleet_size" class="form-control">
			        <option>FINITE</option>
			        <option>INFINITE</option>
			      </select>
			</div>
			<div class="form-group">
			      <label for="fleet_composition">FLEET COMPOSITION</label>
			      <select id="fleet_composition" class="form-control">
			        <option>HOMOGENEOUS</option>
			        <option>HETEROGENEOUS</option>
			      </select>
			</div>
			<div class="form-group">
			    <label for="fleet_size_simulate">FLEET SIZE SIMULATE</label>
                <input type="number" class="form-control" id="fleet_size_simulate" placeholder="10" value="10">
			</div>
			<div class="form-group">
			    <label for="fleet_types_vehicles">FLEET TYPES VEHICLES</label>
                <select id="fleet_composition" class="form-control">
			        <option>CAR</option>
			        <option>MOTORCYCLE</option>
			        <option>FOOT</option>
			    </select>
			</div>
			<div class="form-group">
			    <label for="fleet_cost_by_meter">VEHICLE COST BY METER</label>
                <input type="number" class="form-control" id="fleet_cost_by_meter" placeholder="10" value="1.0">
			</div>
			<div class="form-group">
			    <label for="algorithm_iterations">ALGORITHM ITERATIONS</label>
                <input type="number" class="form-control" id="algorithm_iterations" placeholder="10" value="10">
			</div>
		</form>
		<form role="search">
			<div class="form-group">
				<button class="btn btn-success" type="button" style="width:100%;"onclick="optimization()">OPTIMIZATION</button>
			</div>
	    </form>
		
	</div><!--/.sidebar-->
		
	<div class="col-sm-9 col-sm-offset-3 col-lg-10 col-lg-offset-2 main">			
		
		<div class="row">
			<input id="pac-input" class="controls" type="text" placeholder="Search Box">
			<div id="googleMap" style="width:100%;height:700px;"></div>

		</div><!--/.row-->
		
		<div class="row">
				<div id="information" >
					<h3>Routing Service </h3>
					<pre style="width: 100%;height: 100%; overflow: scroll;" ><code id="routing" class="json"></code></pre>
					<h3>Basic Information </h3>
					<pre style="width: 100%; height: 100%; overflow: scroll;" ><code id="basic" class="json"></code></pre>
		    	</div>
		</div><!--/.row-->
		
	</div>	<!--/.main-->


</body>
</html>